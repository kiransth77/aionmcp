name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        goos: [linux, darwin]
        goarch: [amd64, arm64]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Cache Go modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ${{ env.GOMODCACHE }}
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Build
        run: |
          mkdir -p out
          GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} go build -ldflags "-s -w" -o out/aionmcp-${{ matrix.goos }}-${{ matrix.goarch }} cmd/server/main.go

      - name: Archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: aionmcp-${{ matrix.goos }}-${{ matrix.goarch }}
          path: out/aionmcp-${{ matrix.goos }}-${{ matrix.goarch }}

  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Cache Gradle packages
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Setup Gradle Wrapper
        working-directory: examples/mobile/android-app
        run: gradle wrapper

      - name: Make gradlew executable
        working-directory: examples/mobile/android-app
        run: chmod +x gradlew

      - name: Build Release APK
        working-directory: examples/mobile/android-app
        run: ./gradlew assembleRelease

      - name: Rename APK
        working-directory: examples/mobile/android-app
        run: |
          mkdir -p out
          cp app/build/outputs/apk/release/app-release-unsigned.apk out/aionmcp-android-${{ github.ref_name }}.apk || \
          cp app/build/outputs/apk/release/app-release.apk out/aionmcp-android-${{ github.ref_name }}.apk

      - name: Upload Android APK
        uses: actions/upload-artifact@v4
        with:
          name: aionmcp-android
          path: examples/mobile/android-app/out/*.apk

  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Install Swift dependencies
        working-directory: examples/mobile/ios-app
        run: |
          swift package resolve
          swift build

      - name: Create iOS Archive (Info)
        run: |
          echo "Note: iOS IPA build requires Xcode project with proper code signing."
          echo "Current setup uses Swift Package Manager without Xcode project."
          echo "To enable iOS builds, an Xcode project with signing configuration is needed."
          mkdir -p out
          echo "iOS build requires Xcode project setup" > out/ios-build-info.txt

      - name: Upload iOS Info
        uses: actions/upload-artifact@v4
        with:
          name: aionmcp-ios
          path: out/ios-build-info.txt

  create-release:
    needs: [build-and-release, build-android, build-ios]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: out

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: out/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
